#!/bin/sh

# resize output for easier viewing of logs
resize -s 24 120

# make our users cache dir
mkdir ~/.cache

# symlink our db to the current user
ln -s /app/cve-bin-tool ~/.cache/cve-bin-tool

# launch our tool
cve-bin-tool --offline --detailed -f console,json \
    -o /tmp/thorium/results \
    --sbom-output /tmp/thorium/result-files/results.sbom \
    --sbom-format json \
    "$1"

mv /tmp/thorium/results.json /tmp/thorium/result-files/

jq '{
    "CVEBinToolCVE": [.[] | .cve_number] | unique,
} | . + {CVEBinToolHasCVE: (.CVEBinToolCVE | length > 0)}' \
    < /tmp/thorium/result-files/results.json \
    > /tmp/thorium/tags
